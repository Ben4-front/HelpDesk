(()=>{"use strict";class t{constructor(t){this.apiUrl=t}async list(){const t=await fetch(`${this.apiUrl}/?method=allTickets`);return await t.json()}async get(t){const e=await fetch(`${this.apiUrl}/?method=ticketById&id=${t}`);return await e.json()}async create(t){const e=await fetch(`${this.apiUrl}/?method=createTicket`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await e.json()}async update(t,e){const i=await fetch(`${this.apiUrl}/?method=updateById&id=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return await i.json()}async delete(t){return 204===(await fetch(`${this.apiUrl}/?method=deleteById&id=${t}`)).status}}const e=document.getElementById("root"),i=new class{constructor(e){this.root=e,this.api=new t("http://localhost:7070"),this.container=this.root.querySelector(".tickets-container"),this.modal=document.querySelector("#ticket-modal"),this.deleteModal=document.querySelector("#delete-modal"),this.form=document.querySelector("#ticket-form"),this.currentEditId=null,this.currentDeleteId=null}init(){this.loadTickets(),this.registerEvents()}registerEvents(){const t=this.root.querySelector(".add-ticket-btn");t&&t.addEventListener("click",()=>this.openModal("add")),document.querySelectorAll(".cancel-btn").forEach(t=>t.addEventListener("click",()=>this.closeModals())),this.form&&this.form.addEventListener("submit",t=>this.onSubmit(t));const e=document.querySelector(".confirm-delete-btn");e&&e.addEventListener("click",()=>this.onDeleteConfirm()),this.container.addEventListener("click",t=>this.onTicketClick(t))}async loadTickets(){try{const t=await this.api.list();this.renderTickets(t)}catch(t){console.error("Ошибка загрузки:",t)}}renderTickets(t){this.container.innerHTML="",t.forEach(t=>{const e=this.createTicketElement(t);this.container.appendChild(e)})}createTicketElement(t){const e=new Date(t.created).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit"}),i=document.createElement("div");return i.className="ticket",i.dataset.id=t.id,i.innerHTML=`\n        <div class="ticket-status">\n            <span class="status-circle ${t.status?"done":""}"></span>\n        </div>\n        <div class="ticket-body">\n            <div class="ticket-name">${t.name}</div>\n        </div>\n        <div class="ticket-date">${e}</div>\n        <div class="ticket-controls">\n            <button type="button" class="control-btn edit-btn">✎</button>\n            <button type="button" class="control-btn delete-btn">✖</button>\n        </div>\n        <div class="ticket-description" style="display: none;">Loading...</div>\n    `,i}async onTicketClick(t){const e=t.target.closest(".ticket");if(!e)return;const i=e.dataset.id;if(console.log("Клик по тикету ID:",i,"Цель:",t.target),t.target.closest(".ticket-status")||t.target.classList.contains("status-circle")){const t=e.querySelector(".status-circle"),s=!t.classList.contains("done");t.classList.toggle("done");try{await this.api.update(i,{status:s})}catch(e){console.error("Ошибка обновления статуса:",e),t.classList.toggle("done")}return}if(t.target.closest(".edit-btn"))try{const t=await this.api.get(i);this.openModal("edit",t)}catch(t){console.error("Ошибка получения тикета:",t)}else{if(t.target.closest(".delete-btn"))return this.currentDeleteId=i,void(this.deleteModal?this.deleteModal.classList.add("active"):console.error("Модальное окно удаления не найдено в DOM"));if(!t.target.closest(".ticket-controls")&&t.target.closest(".ticket-body")){const t=e.querySelector(".ticket-description");if("block"===t.style.display)t.style.display="none";else if(t.style.display="block","Loading..."===t.textContent||""===t.textContent)try{const e=await this.api.get(i);t.textContent=e.description||"Нет описания"}catch(e){t.textContent="Ошибка загрузки описания"}}}}openModal(t,e=null){if(!this.modal)return;const i=this.modal.querySelector(".modal-title"),s=this.form.querySelector(".input-name"),n=this.form.querySelector(".input-desc");this.modal.classList.add("active"),"edit"===t&&e?(i.textContent="Изменить тикет",s.value=e.name,n.value=e.description,this.currentEditId=e.id):(i.textContent="Добавить тикет",this.form.reset(),this.currentEditId=null)}closeModals(){this.modal&&this.modal.classList.remove("active"),this.deleteModal&&this.deleteModal.classList.remove("active"),this.form&&this.form.reset()}async onSubmit(t){t.preventDefault();const e=new FormData(this.form),i={name:e.get("name"),description:e.get("description")};try{this.currentEditId?await this.api.update(this.currentEditId,i):(i.status=!1,await this.api.create(i)),this.closeModals(),this.loadTickets()}catch(t){console.error("Ошибка при сохранении:",t)}}async onDeleteConfirm(){if(this.currentDeleteId)try{await this.api.delete(this.currentDeleteId),this.currentDeleteId=null,this.closeModals(),this.loadTickets()}catch(t){console.error("Ошибка удаления:",t)}}}(e);i.init()})();